<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    <%= title %> - All Jobs
  </title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
    }

    .navbar {
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .card {
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
      border: 1px solid rgba(0, 0, 0, 0.125);
      margin-bottom: 1.5rem;
    }

    .job-row {
      transition: background-color 0.2s;
    }

    .job-row:hover {
      background-color: rgba(0, 0, 0, 0.02);
    }

    .status-badge {
      font-size: 0.8rem;
      padding: 0.4rem 0.8rem;
    }

    .progress {
      height: 8px;
      border-radius: 4px;
    }

    .filter-bar {
      background-color: #fff;
      border: 1px solid #dee2e6;
      border-radius: 0.375rem;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }

    .job-id-link {
      text-decoration: none;
      font-family: monospace;
    }

    .job-id-link:hover {
      text-decoration: underline;
    }

    .pagination {
      justify-content: center;
    }

    .navbar-brand {
      font-weight: 600;
    }

    .summary-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
    }

    .summary-stat {
      text-align: center;
      padding: 0.5rem;
    }

    .summary-stat-number {
      font-size: 1.25rem;
      font-weight: bold;
      display: block;
    }

    .summary-stat-label {
      font-size: 0.8rem;
      opacity: 0.8;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">
        <i class="fas fa-video me-2"></i>
        Video Transcoding Service
      </a>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
          <li class="breadcrumb-item"><a href="/" class="text-white-50">Dashboard</a></li>
          <li class="breadcrumb-item active text-white" aria-current="page">All Jobs</li>
        </ol>
      </nav>
      <div class="navbar-nav ms-auto">
        <span class="navbar-text">
          <i class="fas fa-clock me-1"></i>
          <span id="current-time">
            <%= currentTime %>
          </span>
        </span>
      </div>
    </div>
  </nav>

  <div class="container-fluid py-4">
    <!-- Summary Stats -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card summary-card">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="fas fa-chart-bar me-2"></i>
              Job Summary
            </h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-2 col-6">
                <div class="summary-stat">
                  <span class="summary-stat-number">
                    <%= jobCounts.queued %>
                  </span>
                  <div class="summary-stat-label">Queued</div>
                </div>
              </div>
              <div class="col-md-2 col-6">
                <div class="summary-stat">
                  <span class="summary-stat-number">
                    <%= jobCounts.processing %>
                  </span>
                  <div class="summary-stat-label">Processing</div>
                </div>
              </div>
              <div class="col-md-2 col-6">
                <div class="summary-stat">
                  <span class="summary-stat-number">
                    <%= jobCounts.completed %>
                  </span>
                  <div class="summary-stat-label">Completed</div>
                </div>
              </div>
              <div class="col-md-2 col-6">
                <div class="summary-stat">
                  <span class="summary-stat-number">
                    <%= jobCounts.failed %>
                  </span>
                  <div class="summary-stat-label">Failed</div>
                </div>
              </div>
              <div class="col-md-2 col-6">
                <div class="summary-stat">
                  <span class="summary-stat-number">
                    <%= jobCounts.total %>
                  </span>
                  <div class="summary-stat-label">Total</div>
                </div>
              </div>
              <div class="col-md-2 col-6">
                <div class="summary-stat">
                  <span class="summary-stat-number">
                    <%= pagination.total %>
                  </span>
                  <div class="summary-stat-label">Showing</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar">
      <div class="row align-items-center">
        <div class="col-md-6">
          <h4 class="mb-0">
            <i class="fas fa-list me-2"></i>
            All Jobs
          </h4>
          <small class="text-muted">
            Page <%= pagination.page %> of <%= pagination.totalPages %>
                (showing <%= jobs.length %> of <%= pagination.total %> jobs)
          </small>
        </div>
        <div class="col-md-6">
          <div class="d-flex gap-2 justify-content-md-end">
            <select class="form-select form-select-sm" onchange="filterByStatus(this.value)" style="max-width: 150px;">
              <option value="all" <%=filters.status==='all' ? 'selected' : '' %>>All Status</option>
              <option value="queued" <%=filters.status==='queued' ? 'selected' : '' %>>Queued</option>
              <option value="processing" <%=filters.status==='processing' ? 'selected' : '' %>>Processing</option>
              <option value="completed" <%=filters.status==='completed' ? 'selected' : '' %>>Completed</option>
              <option value="failed" <%=filters.status==='failed' ? 'selected' : '' %>>Failed</option>
            </select>
            <a href="/logs" class="btn btn-sm btn-outline-primary">
              <i class="fas fa-file-alt me-1"></i>
              View Logs
            </a>
            <button class="btn btn-sm btn-primary" onclick="refreshPage()">
              <i class="fas fa-sync-alt me-1"></i>
              Refresh
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Jobs Table -->
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-body p-0">
            <% if (jobs && jobs.length> 0) { %>
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>Job ID</th>
                      <th>File</th>
                      <th>Video Name</th>
                      <th>Status</th>
                      <th>Progress</th>
                      <th>Resolutions</th>
                      <th>Created</th>
                      <th>Duration</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% jobs.forEach(function(job) { %>
                      <tr class="job-row">
                        <td>
                          <a href="/job/<%= job.job_id %>" class="job-id-link text-primary">
                            <%= job.job_id.substring(0, 8) %>...
                          </a>
                        </td>
                        <td>
                          <small title="<%= job.original_key %>">
                            <%= job.original_key.length> 30 ? job.original_key.substring(0, 30) + '...' :
                              job.original_key %>
                          </small>
                        </td>
                        <td>
                          <% if (job.metadata && job.metadata.videoName) { %>
                            <span class="badge bg-info text-dark">
                              <%= job.metadata.videoName %>
                            </span>
                            <% } else { %>
                              <span class="text-muted">-</span>
                              <% } %>
                        </td>
                        <td>
                          <% let statusClass='secondary' ; let statusIcon='fas fa-question' ; switch(job.status) {
                            case 'queued' : statusClass='primary' ; statusIcon='fas fa-clock' ; break; case 'processing'
                            : statusClass='warning' ; statusIcon='fas fa-cog fa-spin' ; break; case 'completed' :
                            statusClass='success' ; statusIcon='fas fa-check' ; break; case 'failed' :
                            statusClass='danger' ; statusIcon='fas fa-exclamation-triangle' ; break; } %>
                            <span class="badge bg-<%= statusClass %> status-badge">
                              <i class="<%= statusIcon %> me-1"></i>
                              <%= job.status.charAt(0).toUpperCase() + job.status.slice(1) %>
                            </span>
                        </td>
                        <td>
                          <div class="d-flex align-items-center">
                            <div class="progress me-2" style="width: 80px;">
                              <div class="progress-bar 
                                                            <% if (job.status === 'completed') { %>bg-success<% } 
                                                               else if (job.status === 'failed') { %>bg-danger<% } 
                                                               else if (job.status === 'processing') { %>bg-warning<% } 
                                                               else { %>bg-primary<% } %>"
                                style="width: <%= job.progress || 0 %>%">
                              </div>
                            </div>
                            <small>
                              <%= job.progress || 0 %>%
                            </small>
                          </div>
                        </td>
                        <td>
                          <% if (job.resolutions && job.resolutions.length> 0) { %>
                            <% job.resolutions.forEach(function(resolution, index) { %>
                              <span class="badge bg-light text-dark me-1">
                                <%= resolution %>
                              </span>
                              <% }); %>
                                <% } else { %>
                                  <span class="text-muted">-</span>
                                  <% } %>
                        </td>
                        <td>
                          <small class="text-muted">
                            <%= new Date(job.created_at).toLocaleString() %>
                          </small>
                        </td>
                        <td>
                          <% if (job.duration) { %>
                            <small>
                              <%= Math.round(job.duration) %>s
                            </small>
                            <% } else { %>
                              <span class="text-muted">-</span>
                              <% } %>
                        </td>
                        <td>
                          <div class="btn-group btn-group-sm">
                            <a href="/job/<%= job.job_id %>" class="btn btn-outline-primary btn-sm"
                              title="View Details">
                              <i class="fas fa-eye"></i>
                            </a>
                            <% if (job.status==='failed' ) { %>
                              <button class="btn btn-outline-warning btn-sm" onclick="retryJob('<%= job.job_id %>')"
                                title="Retry Job">
                                <i class="fas fa-redo"></i>
                              </button>
                              <% } %>
                                <% if (job.status==='completed' || job.status==='failed' ) { %>
                                  <button class="btn btn-outline-danger btn-sm"
                                    onclick="deleteJob('<%= job.job_id %>', this)" title="Delete Job">
                                    <i class="fas fa-trash"></i>
                                  </button>
                                  <% } %>
                          </div>
                        </td>
                      </tr>
                      <% }); %>
                  </tbody>
                </table>
              </div>
              <% } else { %>
                <div class="text-center py-5">
                  <i class="fas fa-inbox text-muted" style="font-size: 3rem;"></i>
                  <h5 class="mt-3 text-muted">No jobs found</h5>
                  <p class="text-muted">No jobs match your current filter criteria.</p>
                </div>
                <% } %>
          </div>
        </div>
      </div>
    </div>

    <!-- Pagination -->
    <% if (pagination.totalPages> 1) { %>
      <div class="row mt-4">
        <div class="col-12">
          <nav aria-label="Job pagination">
            <ul class="pagination">
              <% if (pagination.hasPrev) { %>
                <li class="page-item">
                  <a class="page-link" href="?page=<%= pagination.page - 1 %>&status=<%= filters.status %>">
                    <i class="fas fa-chevron-left"></i>
                  </a>
                </li>
                <% } %>

                  <% let startPage=Math.max(1, pagination.page - 2); let endPage=Math.min(pagination.totalPages,
                    pagination.page + 2); %>

                    <% if (startPage> 1) { %>
                      <li class="page-item">
                        <a class="page-link" href="?page=1&status=<%= filters.status %>">1</a>
                      </li>
                      <% if (startPage> 2) { %>
                        <li class="page-item disabled">
                          <span class="page-link">...</span>
                        </li>
                        <% } %>
                          <% } %>

                            <% for (let i=startPage; i <=endPage; i++) { %>
                              <li class="page-item <%= i === pagination.page ? 'active' : '' %>">
                                <a class="page-link" href="?page=<%= i %>&status=<%= filters.status %>">
                                  <%= i %>
                                </a>
                              </li>
                              <% } %>

                                <% if (endPage < pagination.totalPages) { %>
                                  <% if (endPage < pagination.totalPages - 1) { %>
                                    <li class="page-item disabled">
                                      <span class="page-link">...</span>
                                    </li>
                                    <% } %>
                                      <li class="page-item">
                                        <a class="page-link"
                                          href="?page=<%= pagination.totalPages %>&status=<%= filters.status %>">
                                          <%= pagination.totalPages %>
                                        </a>
                                      </li>
                                      <% } %>

                                        <% if (pagination.hasNext) { %>
                                          <li class="page-item">
                                            <a class="page-link"
                                              href="?page=<%= pagination.page + 1 %>&status=<%= filters.status %>">
                                              <i class="fas fa-chevron-right"></i>
                                            </a>
                                          </li>
                                          <% } %>
            </ul>
          </nav>
        </div>
      </div>
      <% } %>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
  <script>
    function updateTime() {
      document.getElementById('current-time').textContent = new Date().toISOString();
    }

    function filterByStatus(status) {
      const currentUrl = new URL(window.location.href);
      currentUrl.searchParams.set('page', '1'); // Reset to first page
      if (status === 'all') {
        currentUrl.searchParams.delete('status');
      } else {
        currentUrl.searchParams.set('status', status);
      }
      window.location.href = currentUrl.toString();
    }

    function refreshPage() {
      window.location.reload();
    }

    function retryJob(jobId) {
      if (confirm('Are you sure you want to retry this job?')) {
        // Note: You'll need to implement the retry API endpoint
        fetch(`/api/transcode/job/${jobId}/retry`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
            // Add your API key header if needed
          }
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('Job queued for retry');
              setTimeout(() => window.location.reload(), 1000);
            } else {
              alert('Failed to retry job: ' + data.error);
            }
          })
          .catch(error => {
            alert('Failed to retry job: ' + error.message);
          });
      }
    }

    function deleteJob(jobId, buttonElement) {
      if (confirm('Are you sure you want to delete this job? This action cannot be undone.')) {
        const originalHtml = buttonElement.innerHTML;
        buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        buttonElement.disabled = true;

        fetch(`/api/job/${jobId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          }
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Remove the row from the table
              const row = buttonElement.closest('tr');
              row.style.transition = 'opacity 0.3s';
              row.style.opacity = '0';
              setTimeout(() => {
                row.remove();
              }, 300);

              // Show success message
              showAlert('Job deleted successfully', 'success');
            } else {
              showAlert('Failed to delete job: ' + data.error, 'danger');
              buttonElement.innerHTML = originalHtml;
              buttonElement.disabled = false;
            }
          })
          .catch(error => {
            showAlert('Failed to delete job: ' + error.message, 'danger');
            buttonElement.innerHTML = originalHtml;
            buttonElement.disabled = false;
          });
      }
    }

    function showAlert(message, type) {
      // Create alert element
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
      alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
      alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

      document.body.appendChild(alertDiv);

      // Auto-remove after 5 seconds
      setTimeout(() => {
        if (alertDiv.parentNode) {
          alertDiv.remove();
        }
      }, 5000);
    }

    // Update time every second
    setInterval(updateTime, 1000);
  </script>
</body>

</html>
